/*	Game: Fire Emblem: the Sacred Stones (US version)
 *	by laqieer
 *	2019-08-30
 */

	.equ ROM_BASE, 0x8000000
	.equ SRAM_BASE, 0xe000000
	
	.arm
	.global _start
_start:
	b load_save_backup
	.incbin	"../FireEmblem8U.gba", 4, 0x1c78 - 4
	/* load save backup from rom to sram when starting the game */
	.thumb
_8001c78:
	ldr r0,=#f_8fa0054
	bx r0
	/* todo: add the original SoftResetIfKeyCombo function */
	.ltorg
	.incbin	"../FireEmblem8U.gba", 0x1c78 + 2 * 2 + 4 * 1, 0x1000000 - (0x1c78 + 2 * 2 + 4 * 1)
	.arm
load_save_backup:
	ldr sp,=#0x3007f00
/*	mov r0,#0xfc
	mov r0,r0,lsl#16
	mov r1,#ROM_BASE
	orr r0,r0,r1	*/
	ldr r0,=save_backup_area
	/* devkitpro tool chain adds a string "dkARM" in the end of the rom (8 byte) */
	add r0,r0,#8
	mov r1,#SRAM_BASE
	mov r2,#0x10
	mov r2,r2,lsl#12
loop:
	ldrb r3,[r0]
	ldrb r4,[r0]
	cmp r3,r4
	bne loop
	strb r3,[r1]
	add r1,r1,#1
	add r0,r0,#1
	subs r2,r2,#1
	bne loop
	ldr r0,=0x8000204
	bx r0

	.thumb
	.thumb_func
f_8fa0054:
	push {lr}
	push {r1-r7}
	ldr r0,=#0x3005d90
	ldr r0,[r0]
	add r0,#0x11
	str r0,[sp]
	ldr r4,=#0x3005d90
	ldr r4,[r4]
	add r4,#0x9a
	add r3,r4,#1
	ldr r7,=#0x201f000
	ldrb r5,[r7]
	ldrb r0,[r0]
	add r2,r7,#1
	cmp r5,r0
	beq l_8fa00ac
	strb r0,[r7]
	ldrb r0,[r2]
	add r6,r0,#1
	lsl r0,r6,#0x18
	lsr r0,r0,#0x18
	strb r0,[r2]
	cmp r0,#0x3b
	ble l_8fa00ac
	mov r6,#0
	strb r6,[r2]
	ldrb r6,[r3]
	sub r6,r6,#1
	lsl r1,r6,#0x18
	lsr r1,r1,#0x18
	cmp r1,#0xff
	bne l_8fa00aa
	mov r6,#0x3b
	strb r6,[r3]
	ldrb r6,[r4]
	sub r6,r6,#1
	and r1,r6
	cmp r1,#0xff
	bne l_8fa00a6
	mov r1,#0x17
	bl f_8fa00be
l_8fa00a6:
	strb r1,[r4]
	b l_8fa00ac
l_8fa00aa:
	strb r1,[r3]
l_8fa00ac:
	pop {r1-r7}
	pop {r0}
	bx r0

	.thumb
	.thumb_func
f_8fa00be:
	push {r0-r2}
	ldr r0,=#0x3005de0
	ldr r0,[r0]
	add r0,#0x98
	ldrh r1,[r0]
	sub r1,r1,#1
	mov r2,#0x94
	cmp r1,r2
	blt l_8fa00d2
	ldr r1,=#0xffff
l_8fa00d2:
	strh r1,[r0]
	pop {r0-r2}
	mov pc,lr

	.align
	
	.thumb
	.thumb_func
backup_save:
	push {lr}
	push {r1, r2, r3, r4, r5}
	ldr r0, _08FA0120
	ldr r1, _08FA0124
	sub r0, r0, #4
	sub r1, r1, #4
	mov r3, #0xff
_08FA00FC:
	strb r3, [r0]
	add r0, r0, #1
	cmp r0, r1
	bne _08FA00FC
	mov r4, #1
	ldr r0, _08FA0128
	bx r0
	pop {r1, r2, r3, r4, r5}
	pop {r0}
	bx r0
	.align
_08FA0120: .4byte 0x0E000004
_08FA0124: .4byte 0x0E010004
_08FA0128: .4byte sub_08FA0130

	.arm
sub_08FA0130:
	push {r0, r1, r2, r3, r4, r5, r6, r7}
	ldr r0, _08FA0238
	ldr r1, _08FA023C
	ldrh r2, [r0]
	strh r2, [r1]
	ldr r0, _08FA0240
	ldr r1, _08FA0244
	ldrh r2, [r0]
	strh r2, [r1], #2
	mov r0, #0x4000000
	ldrh r2, [r0, #0x82]
	strh r2, [r1], #2
	ldrh r2, [r0, #0x80]
	strh r2, [r1], #2
	ldrh r2, [r0, #0xba]
	strh r2, [r1], #2
	ldrh r2, [r0, #0xc6]
	strh r2, [r1], #2
	ldrh r2, [r0, #0xd2]
	strh r2, [r1], #2
	ldrh r2, [r0, #0xde]
	strh r2, [r1], #2
	mov r0, #0
	ldr r1, _08FA0238
	strh r0, [r1]
	ldr r1, _08FA0240
	strh r0, [r1]
	mov r1, #0x4000000
	strh r0, [r1, #0x80]
	strh r0, [r1, #0xba]
	strh r0, [r1, #0xc6]
	strh r0, [r1, #0xd2]
	strh r0, [r1, #0xde]
	mov r0, #3
	strh r0, [r1, #0x82]
	ldr r0, _08FA0248
	ldrh r1, [r0]
	b _08FA0254
	.byte 0x68, 0x00, 0x9F, 0xE5, 0x68, 0x10, 0x9F, 0xE5
	.byte 0xB0, 0x20, 0xD1, 0xE1, 0xB0, 0x20, 0xC0, 0xE1, 0x60, 0x00, 0x9F, 0xE5, 0x60, 0x10, 0x9F, 0xE5
	.byte 0xB2, 0x20, 0xD1, 0xE0, 0xB0, 0x20, 0xC0, 0xE1, 0x01, 0x03, 0xA0, 0xE3, 0xB2, 0x20, 0xD1, 0xE0
	.byte 0xB2, 0x28, 0xC0, 0xE1, 0xB2, 0x20, 0xD1, 0xE0, 0xB0, 0x28, 0xC0, 0xE1, 0xB2, 0x20, 0xD1, 0xE0
	.byte 0xBA, 0x2B, 0xC0, 0xE1, 0xB2, 0x20, 0xD1, 0xE0, 0xB6, 0x2C, 0xC0, 0xE1, 0xB2, 0x20, 0xD1, 0xE0
	.byte 0xB2, 0x2D, 0xC0, 0xE1, 0xB2, 0x20, 0xD1, 0xE0, 0xBE, 0x2D, 0xC0, 0xE1, 0xFF, 0x00, 0xBD, 0xE8
	.byte 0x01, 0x00, 0x54, 0xE3, 0x01, 0x00, 0x00, 0x0A, 0x1C, 0x10, 0x9F, 0xE5, 0x11, 0xFF, 0x2F, 0xE1
	.byte 0x18, 0x00, 0x9F, 0xE5, 0x10, 0xFF, 0x2F, 0xE1
_08FA0238: .4byte 0x04000208
_08FA023C: .4byte 0x0203FC00
_08FA0240: .4byte 0x04000200
_08FA0244: .4byte 0x0203FC02
_08FA0248: .4byte 0x04000084
	.byte 0x19, 0x01, 0xFA, 0x08
	.byte 0x0B, 0x01, 0xFA, 0x08
_08FA0254:
	ldr r0, _08FA03E4
	ldr r1, _08FA03E8
	ldr r2, _08FA03EC
_08FA0260:
	ldr r3, [r1]
	str r3, [r0]
	add r1, r1, #4
	add r0, r0, #4
	cmp r1, r2
	bne _08FA0260
	ldr r0, _08FA03E4
	bx r0
	.byte 0x68, 0x01, 0x9F, 0xE5, 0x68, 0x11, 0x9F, 0xE5, 0xB0, 0x00, 0xC1, 0xE1, 0x64, 0x01, 0x9F, 0xE5
	.byte 0xB0, 0x00, 0xC1, 0xE1, 0x60, 0x01, 0x9F, 0xE5, 0xB0, 0x10, 0xD0, 0xE1, 0x5C, 0x21, 0x9F, 0xE5
	.byte 0x02, 0x00, 0x51, 0xE1, 0x04, 0x00, 0x00, 0x1A, 0x40, 0x01, 0x9F, 0xE5, 0x02, 0x13, 0xA0, 0xE3
	.byte 0xB0, 0x00, 0xC1, 0xE1, 0x00, 0x00, 0xA0, 0xE3, 0x36, 0x00, 0x00, 0xEA, 0x02, 0x03, 0xA0, 0xE3
	.byte 0xFF, 0x10, 0xA0, 0xE3, 0xB0, 0x10, 0xC0, 0xE1, 0x00, 0x00, 0xA0, 0xE1, 0x50, 0x10, 0xA0, 0xE3
	.byte 0xB0, 0x10, 0xC0, 0xE1, 0x00, 0x00, 0xA0, 0xE1, 0x90, 0x10, 0xA0, 0xE3, 0xB0, 0x10, 0xC0, 0xE1
	.byte 0x00, 0x00, 0xA0, 0xE1, 0x08, 0x20, 0xA0, 0xE3, 0xB0, 0x10, 0xD0, 0xE1, 0x8A, 0x00, 0x51, 0xE3
	.byte 0x08, 0x00, 0x00, 0x0A, 0x01, 0x20, 0x52, 0xE2, 0xFA, 0xFF, 0xFF, 0x1A, 0x89, 0x00, 0x51, 0xE3
	.byte 0x26, 0x00, 0x00, 0x0A, 0x02, 0x03, 0xA0, 0xE3, 0xF0, 0x10, 0xA0, 0xE3, 0xB0, 0x10, 0xC0, 0xE1
	.byte 0x02, 0x00, 0xA0, 0xE3, 0x1F, 0x00, 0x00, 0xEA, 0x02, 0x03, 0xA0, 0xE3, 0xFF, 0x10, 0xA0, 0xE3
	.byte 0xB0, 0x10, 0xC0, 0xE1, 0x00, 0x00, 0xA0, 0xE1, 0x90, 0x10, 0xA0, 0xE3, 0xB0, 0x10, 0xC0, 0xE1
	.byte 0x00, 0x00, 0xA0, 0xE1, 0x02, 0x03, 0xA0, 0xE3, 0x02, 0x00, 0x80, 0xE2, 0xB0, 0x10, 0xD0, 0xE1
	.byte 0xBC, 0x20, 0x9F, 0xE5, 0x02, 0x00, 0x51, 0xE1, 0x03, 0x00, 0x00, 0x1A, 0xFF, 0x10, 0xA0, 0xE3
	.byte 0xB0, 0x10, 0xC0, 0xE1, 0x03, 0x00, 0xA0, 0xE3, 0x0E, 0x00, 0x00, 0xEA, 0xA4, 0x20, 0x9F, 0xE5
	.byte 0x02, 0x00, 0x51, 0xE1, 0x05, 0x00, 0x00, 0x1A, 0x02, 0x00, 0x50, 0xE2, 0x00, 0x60, 0xA0, 0xE3
	.byte 0xFF, 0x10, 0xA0, 0xE3, 0xB0, 0x10, 0xC0, 0xE1, 0x01, 0x00, 0xA0, 0xE3, 0x05, 0x00, 0x00, 0xEA
	.byte 0x84, 0x20, 0x9F, 0xE5, 0x02, 0x00, 0x51, 0xE1, 0xF6, 0xFF, 0xFF, 0x0A, 0xF0, 0x10, 0xA0, 0xE3
	.byte 0xB0, 0x10, 0xC0, 0xE1, 0x00, 0x00, 0xA0, 0xE3, 0x70, 0x10, 0x9F, 0xE5, 0x11, 0xFF, 0x2F, 0xE1
	.byte 0xFF, 0x60, 0xA0, 0xE3, 0xFF, 0x10, 0xA0, 0xE3, 0xB0, 0x10, 0xC0, 0xE1, 0x01, 0x00, 0xA0, 0xE3
	.byte 0xF8, 0xFF, 0xFF, 0xEA, 0x00, 0x00, 0x50, 0xE3, 0x05, 0x00, 0x00, 0x0A, 0x01, 0x00, 0x50, 0xE3
	.byte 0x04, 0x00, 0x00, 0x0A, 0x02, 0x00, 0x50, 0xE3, 0x03, 0x00, 0x00, 0x0A, 0x03, 0x00, 0x50, 0xE3
	.byte 0x02, 0x00, 0x00, 0x0A, 0x0F, 0x00, 0x00, 0xEA, 0xD5, 0x00, 0x00, 0xEA, 0x77, 0x00, 0x00, 0xEA
	.byte 0x44, 0x01, 0x00, 0xEA
_08FA03E4: .4byte 0x0203FC10
_08FA03E8: .4byte 0x08FA0280
_08FA03EC: .4byte 0x08FA0414
	
	.ltorg

	.align
save_backup_area:

